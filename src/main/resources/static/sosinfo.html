<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOS Setup - TrekSafe</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #254d23;
            padding-bottom: 50px;
        }
        .container {
            max-width: 800px;
        }
        .form-header {
            color: #254d23;
            font-weight: 700;
        }
        .form-section-card {
            background-color: #ffffff;
            border: none;
            border-radius: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 2rem;
            margin-bottom: 1.5rem;
        }
        .btn-add, .btn-save {
            background-color: #a9744f;
            border-color: #a9744f;
            color: #fff;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-add:hover, .btn-save:hover {
            background-color: #926544;
            border-color: #926544;
        }
        .contact-item {
            background-color: #f1f8f0; /* Light green background */
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
        }
        .remove-contact-btn {
            background: none;
            border: none;
            color: #d9534f;
            font-size: 1.2rem;
            transition: color 0.2s;
        }
        .remove-contact-btn:hover {
            color: #c9302c;
        }
        .form-control:focus, textarea:focus {
            border-color: #254d23;
            box-shadow: 0 0 0 0.25rem rgba(37, 77, 35, 0.25);
        }
        /* Message Box Styling */
        #message-box {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-weight: 600;
        }
        .alert-success-custom {
            background-color: #d1e7dd;
            color: #0f5132;
            border: 1px solid #badbcc;
        }
        .alert-danger-custom {
            background-color: #f8d7da;
            color: #842029;
            border: 1px solid #f5c2c7;
        }
    </style>
</head>
<body>

<!-- Custom Message Box Element -->
<div id="message-box" role="alert"></div>

<div class="container my-5">
    <h1 class="text-center mb-4 form-header">TrekSafe SOS Data Setup</h1>
    <p class="text-center text-muted mb-5">Keep this information updated. In case of an emergency, this data will be crucial for rescue and contact.</p>

    <!-- SECTION 1: Emergency Contacts -->
    <div class="form-section-card">
        <h3 class="mb-4">1. Emergency Contacts</h3>

        <!-- Input fields for new contact -->
        <div class="input-group mb-3">
            <input type="text" id="contact-name" class="form-control" placeholder="Contact Name (e.g., Jane Doe)" aria-label="Contact Name">
            <input type="tel" id="contact-phone" class="form-control" placeholder="Phone Number (e.g., 555-123-4567)" aria-label="Contact Phone">
            <button class="btn btn-add" type="button" id="add-contact-btn">Add Contact</button>
        </div>

        <!-- List of added contacts -->
        <div id="contacts-list" class="mt-4">
            <!-- Contacts will be added here -->
        </div>
    </div>

    <!-- SECTION 2: Medical and Custom Notes -->
    <div class="form-section-card">
        <h3 class="mb-4">2. Medical & Safety Info</h3>

        <div class="mb-4">
            <label for="medical-info" class="form-label">Medical Conditions / Allergies</label>
            <textarea class="form-control" id="medical-info" rows="3" placeholder="e.g., Type 1 Diabetes, severe bee sting allergy, blood type O+"></textarea>
        </div>

        <div class="mb-4">
            <label for="custom-note" class="form-label">Custom Rescue Note</label>
            <textarea class="form-control" id="custom-note" rows="3" placeholder="Any specific instructions for first responders or family members. e.g., 'Check my GPS device for last known location.'"></textarea>
        </div>
    </div>

    <!-- SAVE BUTTON -->
    <div class="text-center mt-5">
        <button id="save-all-btn" class="btn btn-save btn-lg w-100" style="max-width: 400px;">
            <i class="bi bi-save me-2"></i> Save All SOS Data Securely
        </button>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_URL = 'http://localhost:8080/api/v1/sos';

    // NOTE: This token is a placeholder. In the next step, we MUST implement JWT
    // authentication so this token is retrieved from the successful login response.
    const AUTH_TOKEN = 'dummy_token_replace_with_jwt';

    // Utility function to display custom messages
    function showMessage(message, isSuccess) {
        const msgBox = document.getElementById('message-box');
        msgBox.textContent = message;
        msgBox.className = ''; // Reset classes

        if (isSuccess) {
            msgBox.classList.add('alert-success-custom');
        } else {
            msgBox.classList.add('alert-danger-custom');
        }

        msgBox.style.display = 'block';

        // Automatically hide the message after 5 seconds
        setTimeout(() => {
            msgBox.style.display = 'none';
        }, 5000);
    }

    // Function to visually add a contact to the list
    function addContact(name, phone) {
        const contactsList = document.getElementById('contacts-list');
        if (!name || !phone) {
            showMessage("Please enter both a name and a phone number.", false);
            return;
        }

        // Basic formatting
        const formattedPhone = phone.replace(/[^0-9]/g, '').replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');

        const contactEl = document.createElement('div');
        contactEl.className = 'contact-item d-flex justify-content-between align-items-center';
        contactEl.innerHTML = `
            <div>
                <p class="fw-medium mb-0">${name}</p>
                <p class="small text-muted mb-0">${formattedPhone}</p>
            </div>
            <button class="remove-contact-btn" type="button" aria-label="Remove contact">
                <i class="bi bi-x-circle-fill"></i>
            </button>
        `;
        contactsList.appendChild(contactEl);

        // Clear inputs after adding
        document.getElementById('contact-name').value = '';
        document.getElementById('contact-phone').value = '';
    }

    // Function to retrieve SOS data from the server
    async function fetchSOSData() {
        try {
            const response = await fetch(API_URL, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${AUTH_TOKEN}` // Requires a valid JWT
                }
            });

            if (response.status === 401) {
                showMessage("Authentication Required. Please log in first.", false);
                return;
            }

            if (!response.ok) {
                // If it's a 404, the user just hasn't saved data yet, which is fine.
                // We only show an error if it's a real server issue.
                if (response.status !== 404) {
                    const errorData = await response.json();
                    showMessage(errorData.message || `Failed to load data (Status: ${response.status})`, false);
                }
                return;
            }

            const data = await response.json();

            // 1. Populate Medical and Notes
            document.getElementById('medical-info').value = data.medicalInfo || '';
            document.getElementById('custom-note').value = data.customNote || '';

            // 2. Populate Contacts List
            const contactsList = document.getElementById('contacts-list');
            contactsList.innerHTML = ''; // Clear existing
            if (data.contacts && Array.isArray(data.contacts)) {
                data.contacts.forEach(contact => {
                    addContact(contact.name, contact.phone);
                });
            }
            showMessage("SOS data loaded successfully!", true);

        } catch (error) {
            console.error('Network or Server Connection Error:', error);
            showMessage('Error: Could not connect to the backend server. Is Spring Boot running?', false);
        }
    }

    // Function to save SOS data to the server
    async function saveSOSData(sosData) {
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${AUTH_TOKEN}` // Requires a valid JWT
                },
                body: JSON.stringify(sosData)
            });

            if (response.status === 401) {
                showMessage("Authentication Required. Please log in first.", false);
                return;
            }

            if (!response.ok) {
                const errorData = await response.json();
                showMessage(errorData.message || `Failed to save data (Status: ${response.status})`, false);
                return;
            }

            // Success response
            showMessage("SOS Data saved successfully to the database!", true);

        } catch (error) {
            console.error('Network or Server Connection Error during save:', error);
            showMessage('Error: Could not connect to the backend server. Is Spring Boot running?', false);
        }
    }


    // --- Event Listeners and Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        const addContactBtn = document.getElementById('add-contact-btn');
        const contactNameInput = document.getElementById('contact-name');
        const contactPhoneInput = document.getElementById('contact-phone');
        const contactsList = document.getElementById('contacts-list');
        const saveAllBtn = document.getElementById('save-all-btn');

        // Load existing data when the page opens
        // This will likely fail with a 401 until JWTs are implemented, but it's the correct flow.
        fetchSOSData();

        // Add contact listener
        addContactBtn.addEventListener('click', () => {
            addContact(contactNameInput.value.trim(), contactPhoneInput.value.trim());
        });

        // Allow Enter key to add contact
        contactPhoneInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent default form submission on enter
                addContact(contactNameInput.value.trim(), contactPhoneInput.value.trim());
            }
        });

        // Remove contact listener (event delegation)
        contactsList.addEventListener('click', (e) => {
            if (e.target.closest('.remove-contact-btn')) {
                e.target.closest('.contact-item').remove();
            }
        });

        // Save Data Listener
        saveAllBtn.addEventListener('click', () => {
            const contacts = [];
            // 1. Gather all contacts from the UI list
            document.querySelectorAll('#contacts-list > div').forEach(contactEl => {
                const name = contactEl.querySelector('p.fw-medium').textContent;
                const phone = contactEl.querySelector('p.small').textContent.replace(/-/g, ''); // Clean phone number before sending
                contacts.push({ name, phone });
            });

            // 2. Gather notes
            const medicalInfo = document.getElementById('medical-info').value.trim();
            const customNote = document.getElementById('custom-note').value.trim();

            // 3. Construct the payload matching the SOSData DTO structure
            const sosData = {
                contacts,
                medicalInfo,
                customNote
            };

            // 4. Send to server
            saveSOSData(sosData);
        });
    });
</script>
</body>
</html>
