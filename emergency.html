<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Assistance</title>
    <!-- Bootstrap CSS for utilities and better responsiveness -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f3ef; /* light earthy background */
            color: #2f3e2f;
        }

        header {
            background: #2e5339; /* deep forest green */
            color: #fdfcf9;
            text-align: center;
            padding: 1.2rem;
            font-size: 1.6rem;
            font-weight: bold;
            letter-spacing: 1px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .container {
            padding: 1.5rem;
            max-width: 900px;
            margin: auto;
        }

        .section {
            background: #ffffff;
            padding: 1.2rem;
            margin-bottom: 1.5rem;
            border-radius: 14px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .section h2 {
            font-size: 1.3rem;
            margin-bottom: 0.8rem;
            color: #3b4d3b;
            border-left: 4px solid #6a994e; /* earthy accent */
            padding-left: 0.5rem;
        }

        .location-box {
            background: #eaf1ea;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
            color: #2e5339;
            margin-bottom: 1.5rem;
        }

        .contacts div {
            margin: 0.6rem 0;
            padding: 0.9rem;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            background: #f0f4f0;
            border-left: 6px solid;
        }

        .police { border-color: #6a994e; }
        .medical { border-color: #bc4749; }
        .forest { border-color: #f4a261; }
        .rescue { border-color: #386641; }

        .contacts button {
            background: #6a994e;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 14px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        .contacts button:hover {
            background: #52734d;
        }

        .alert-btn {
            display: block;
            width: 100%;
            background: #bc4749; /* muted earthy red for emergency */
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
            padding: 1.2rem;
            text-align: center;
            border-radius: 14px;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        .alert-btn:hover {
            background: #a63a3c;
        }

        /* Custom Message Box Styling (Copied from sos.html for consistency) */
        #message-box {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-weight: 600;
        }
        .alert-success-custom {
            background-color: #d1e7dd;
            color: #0f5132;
            border: 1px solid #badbcc;
        }
        .alert-danger-custom {
            background-color: #f8d7da;
            color: #842029;
            border: 1px solid #f5c2c7;
        }
    </style>
</head>
<body>

<!-- Custom Message Box Element -->
<div id="message-box" role="alert"></div>

<header>Emergency Assistance</header>
<div class="container">

    <!-- Location Info -->
    <div class="location-box" id="locationBox">
        üìç Detecting your location...
    </div>

    <!-- Emergency Contacts -->
    <div class="section">
        <h2>Emergency Contacts</h2>
        <div class="contacts">
            <div class="police">
                Police Helpline
                <button onclick="callNumber('100')">Call</button>
            </div>
            <div class="medical">
                Medical Emergency
                <button onclick="callNumber('108')">Call</button>
            </div>
            <div class="forest">
                Forest Dept.
                <button onclick="callNumber('1926')">Call</button>
            </div>
            <div class="rescue">
                Rescue / Disaster Mgmt
                <button onclick="callNumber('112')">Call</button>
            </div>
        </div>
    </div>

    <!-- Emergency Beacon -->
    <div class="section">
        <h2>Quick SOS</h2>
        <button class="alert-btn" id="send-alert-btn">üö® SOS</button>
    </div>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_URL_ALERT = 'http://localhost:8080/api/v1/emergency/alert';
    // NOTE: This token is a placeholder. It MUST be replaced with a real JWT.
    const AUTH_TOKEN = 'dummy_token_replace_with_jwt';

    let lastKnownLocation = { latitude: null, longitude: null };

    // Utility function to display custom messages (replaces alert())
    function showMessage(message, isSuccess) {
        const msgBox = document.getElementById('message-box');
        msgBox.textContent = message;
        msgBox.className = ''; // Reset classes

        if (isSuccess) {
            msgBox.classList.add('alert-success-custom');
        } else {
            msgBox.classList.add('alert-danger-custom');
        }

        msgBox.style.display = 'block';

        // Automatically hide the message after 5 seconds
        setTimeout(() => {
            msgBox.style.display = 'none';
        }, 5000);
    }

    // Function for making phone calls
    function callNumber(number) {
        window.location.href = `tel:${number}`;
    }

    // Function to continuously get and display location
    function getLocation() {
        const locationBox = document.getElementById("locationBox");

        if (!navigator.geolocation) {
            locationBox.innerHTML = "‚ùå Geolocation not supported by your device.";
            showMessage("Geolocation is not supported. SOS Alert will not transmit location.", false);
            return;
        }

        // Use watchPosition to get continuous updates
        navigator.geolocation.watchPosition(
            (pos) => {
                const lat = pos.coords.latitude.toFixed(6);
                const lon = pos.coords.longitude.toFixed(6);

                // Store the latest location
                lastKnownLocation.latitude = pos.coords.latitude;
                lastKnownLocation.longitude = pos.coords.longitude;

                locationBox.innerHTML = `
                    <span class="fw-bold">üìç Current Location:</span><br>
                    Lat: ${lat}, Lon: ${lon}
                    <span class="text-success small">(Live)</span>
                `;
            },
            () => {
                locationBox.innerHTML = "‚ö†Ô∏è Unable to detect location. Please enable GPS.";
                lastKnownLocation.latitude = null;
                lastKnownLocation.longitude = null;
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
    }

    // Function to send the SOS alert via API
    async function sendAlert() {
        const btn = document.getElementById('send-alert-btn');
        btn.disabled = true;
        btn.textContent = 'Sending Alert...';

        if (lastKnownLocation.latitude === null) {
            showMessage("‚ö†Ô∏è Cannot send alert: Location data is unavailable. Check GPS permissions.", false);
            btn.disabled = false;
            btn.textContent = 'üö® SOS';
            return;
        }

        const alertData = {
            latitude: lastKnownLocation.latitude,
            longitude: lastKnownLocation.longitude
            // The Spring Boot server will automatically associate this with the logged-in user
        };

        try {
            const response = await fetch(API_URL_ALERT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${AUTH_TOKEN}` // Requires a valid JWT
                },
                body: JSON.stringify(alertData)
            });

            if (response.status === 401) {
                showMessage("Alert Failed: Authentication Required. Please log in first.", false);
                return;
            }

            if (!response.ok) {
                const errorData = await response.json();
                showMessage(errorData.message || `Alert Failed (Status: ${response.status})`, false);
                return;
            }

            // Success response
            showMessage("‚úÖ SOS Alert sent successfully! Help is on the way.", true);

        } catch (error) {
            console.error('Network or Server Connection Error during alert:', error);
            showMessage('Error: Could not connect to the backend server. Is Spring Boot running?', false);
        } finally {
            btn.disabled = false;
            btn.textContent = 'üö® SOS';
        }
    }


    // --- Event Listeners and Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        // Start watching for location updates immediately
        getLocation();

        // Attach event listener to the SOS button
        document.getElementById('send-alert-btn').addEventListener('click', sendAlert);
    });
</script>
</body>
</html>
